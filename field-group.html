<script>
  window.addEventListener('DOMContentLoaded', function () {

    // ファイルが選択されたら実行
    document.getElementById("uploadFile").addEventListener('change', function (e) {
      //ファイルを選択したときのファイル情報のオブジェクト
      let fileReader = new FileReader();

      // ファイルの読み込みを行ったら実行
      fileReader.addEventListener('load', function (e) {
        const csvDatas = []; // 最終的な二次元配列を入れるための配列
        const tmps = e.target.result.split(/\r\n|\n/); // 改行を区切り文字として行を要素とした配列を生成
        const noEmptyTmps = tmps.filter(function (s) { // 空要素削除
          return s !== '';
        });

        // 各行ごとにカンマで区切った文字列を要素とした二次元配列を生成
        const CategoryNames = noEmptyTmps[0].split(',');
        //カンマごとに要素を区切って配列に格納
        noEmptyTmps.forEach((rowOfData, varse) => {
          csvDatas[varse] = rowOfData.split(',');
        })
        //カテゴリー名の要素を削除
        csvDatas.splice(0, 1);
        //csvデータのオブジェクト生成
        const csvInfos = [];
        csvDatas.forEach((data, number) => {
          let csvGroup = {};
          CategoryNames.forEach((key, index) => {
            //keyが同じ名前だと上書きしてしまう
            csvGroup[key] = csvDatas[number][index];
          })
          csvInfos.push(csvGroup);
        })
        console.log(csvInfos)
        //テキストの場合
        csvInfos.forEach((csvElement, csvIndex) => {
          const contentArea = Array.from(document.getElementsByClassName("item-template"));
          const prevInput = contentArea[0].querySelectorAll("input");
          const prevSelect = contentArea[0].querySelectorAll("select");
          //inputタグのname属性をそろえる
          for (let x = 0; x < prevInput.length; x++){
            if (prevInput[x].hasAttribute("name")){
              prevInput[x].name = prevInput[x].name.replace('[]','');
            }
          }
          //selectタグのname属性をそろえる
          for (let y = 0; y < prevSelect.length; y++){
            if (prevSelect[y].hasAttribute("name")){
              prevSelect[y].name = prevSelect[y].name.replace('[]','');
            }
          }
          console.log(prevInput)
          contentArea[0].classList.remove("item-template");
          console.log(contentArea[0])
          //複製
          const cloneElement = contentArea[0].cloneNode(true);
          contentArea[0].classList.add("item-template");
          // 複製した要素の属性を編集
          cloneElement.removeAttribute("style");
          //複製した要素の子孫要素編集
          const inputElement = cloneElement.querySelectorAll("input");
          const selectElement = cloneElement.querySelectorAll("select");
          inputElement.forEach((input, form) => {
            input.removeAttribute("disabled");
            if (form !== inputElement.length - 1) {
              for (let i = 0; i < CategoryNames.length; i++) {
                if (input.name === CategoryNames[i]) {
                  input.name = CategoryNames[i] + "[" + csvIndex + 1  + "]";
                  if (input.type === "text") {
                    input.value = Object.values(csvElement)[i];
                  } else if (input.type === "radio") {
                    if (input.value === Object.values(csvElement)[i]) {
                      input.checked = true;
                    }
                  }
                }
              }
            } else {
              ;
            }
          })
          selectElement.forEach((select, selenumber) => {
            select.removeAttribute("disabled");
            for (let t = 0; t < CategoryNames.length; t++) {
              if (select.name === CategoryNames[t]) {
                select.name = CategoryNames[t] + "[" + csvIndex + "]";
                const optionElement = select.querySelectorAll("option");
                optionElement.forEach((option, optiNumber) => {
                  for (let e = 0; e < CategoryNames.length; e++) {
                    if (option.value === Object.values(csvElement)[e]) {
                      option.selected = true;
                    }
                  }
                })
              }
            }
          })
          console.log(cloneElement);
          contentArea[0].before(cloneElement);
        });
      });
      //指定されたファイルの内容を読み取り、完了後csvDatasプロパティにファイルの内容を文字列として格納
      fileReader.readAsText(e.target.files[0]);
    });
  });
</script>

<h2 class="acms-admin-admin-title2">サンプル</h2>
<table class="js-fieldgroup-sortable adminTable acms-admin-table-admin-edit">
  <thead class="acms-admin-hide-sp">
    <tr>
      <th class="acms-admin-table-left acms-admin-admin-config-table-item-handle"> </th>
      <th class="acms-admin-table-left">動物</th>
      <th class="acms-admin-table-left">食べ物</th>
      <th class="acms-admin-table-left">色</th>
      <th class="acms-admin-table-left acms-admin-admin-config-table-action">削除</th>
    </tr>
  </thead>
  <tbody>
    <!-- BEGIN sample:loop -->
    <tr class="sortable-item">
      <td class="item-handle acms-admin-table-nowrap">
        <i class="acms-admin-icon-sort"></i>
      </td>
      <td>
        <div class="acms-admin-form-radio">
          <input type="radio" name="animal[]" value="dog" {animal:checked#dog} id="input-radio-animal-dog" />
          <label for="input-radio-animal-dog">
            <i class="acms-admin-ico-radio"></i>dog</label>
        </div>
        <div class="acms-admin-form-radio">
          <input type="radio" name="animal[]" value="cat" {animal:checked#cat} id="input-radio-animal-cat" />
          <label for="input-radio-animal-cat">
            <i class="acms-admin-ico-radio"></i>cat</label>
        </div>
        <div class="acms-admin-form-radio">
          <input type="radio" name="animal[]" value="monkey" {animal:checked#monkey} id="input-radio-animal-monkey" />
          <label for="input-radio-animal-monkey">
            <i class="acms-admin-ico-radio"></i>monkey</label>
        </div>
      </td>
      <td>
        <input type="text" name="food[]" value="{food}" class="acms-admin-form-width-full" />
      </td>
      <td>
        <select name="color[]" class="acms-admin-form-width-full">
          <option value=""></option>
          <option value="red" {color:selected#red}>red</option>
          <option value="blue" {color:selected#blue}>blue</option>
          <option value="green" {color:selected#green}>green</option>
        </select>
      </td>
      <td class="acms-admin-table-nowrap">
        <input type="button" class="item-delete acms-admin-btn-admin acms-admin-btn-admin-danger" value="削除" />
      </td>
    </tr>
    <!-- END sample:loop -->
    <tr class="sortable-item item-template">
      <td class="item-handle acms-admin-table-nowrap">
        <i class="acms-admin-icon-sort"></i>
      </td>
      <td>
        <div class="acms-admin-form-radio">
          <input type="radio" name="animal[]" value="dog" id="input-radio-animal-dog" />
          <label for="input-radio-animal-dog">
            <i class="acms-admin-ico-radio"></i>dog</label>
        </div>
        <div class="acms-admin-form-radio">
          <input type="radio" name="animal[]" value="cat" id="input-radio-animal-cat" />
          <label for="input-radio-animal-cat">
            <i class="acms-admin-ico-radio"></i>cat</label>
        </div>
        <div class="acms-admin-form-radio">
          <input type="radio" name="animal[]" value="monkey" id="input-radio-animal-monkey" />
          <label for="input-radio-animal-monkey">
            <i class="acms-admin-ico-radio"></i>monkey</label>
        </div>
      </td>
      <td>
        <input type="text" name="food[]" value="" class="acms-admin-form-width-full" />
      </td>
      <td>
        <select name="color[]" class="acms-admin-form-width-full">
          <option value=""></option>
          <option value="red">red</option>
          <option value="blue">blue</option>
          <option value="green">green</option>
        </select>
      </td>
      <td class="acms-admin-table-nowrap">
        <input type="button" class="item-delete acms-admin-btn-admin acms-admin-btn-admin-danger" value="削除" />
      </td>
    </tr>
  </tbody>
  <tfoot>
    <tr>
      <td colSpan="5">
        <input type="button" class="item-insert acms-admin-btn-admin" value="追加" />
      </td>
    </tr>
  </tfoot>
</table>
<input type="hidden" name="@sample[]" value="animal" />
<input type="hidden" name="field[]" value="animal" />
<input type="hidden" name="@sample[]" value="food" />
<input type="hidden" name="field[]" value="food" />
<input type="hidden" name="@sample[]" value="color" />
<input type="hidden" name="field[]" value="color" />
<input type="hidden" name="field[]" value="@sample" />

<input type="file" class="item-insert" id="uploadFile">
