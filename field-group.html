<script>
  window.addEventListener('DOMContentLoaded', function () {

    // ファイルが選択されたら実行
    document.getElementById("uploadFile").addEventListener('change', function (e) {
      //ファイルを選択したときのファイル情報のオブジェクト
      let fileReader = new FileReader();

      // ファイルの読み込みを行ったら実行
      fileReader.addEventListener('load', function (e) {
        const csvDatas = []; // 最終的な二次元配列を入れるための配列
        const tmps = e.target.result.split(/\r\n|\n/); // 改行を区切り文字として行を要素とした配列を生成
        const noEmptyTmps = tmps.filter(function (s) { // 空要素削除
          return s !== '';
        });

        // 各行ごとにカンマで区切った文字列を要素とした二次元配列を生成
        const CategoryNames = noEmptyTmps[0].split(',');
        //カンマごとに要素を区切って配列に格納
        noEmptyTmps.forEach((rowOfData, varse) => {
          csvDatas[varse] = rowOfData.split(',');
        })
        //カテゴリー名の要素を削除
        csvDatas.splice(0, 1);
        //csvデータのオブジェクト生成
        const csvInfos = [];
        csvDatas.forEach((data, number) => {
          let csvGroup = {};
          CategoryNames.forEach((key, index) => {
            csvGroup[key] = csvDatas[number][index];
          })
          csvInfos.push(csvGroup);
        })
        //テキストの場合
        csvInfos.forEach((csvElement, csvIndex) => {
          //元々あったフォームの数を知る
          const prevTd = Array.from(document.getElementsByClassName("sortable-item"))
          prevTd.pop();
          const contentArea = Array.from(document.getElementsByClassName("item-template"));
          const prevInput = Array.from(contentArea[0].querySelectorAll("input"));
          const prevSelect = Array.from(contentArea[0].querySelectorAll("select"));
          const prevTextArea = Array.from(contentArea[0].querySelectorAll("textarea"))
          //inputタグのname属性にある[]を削除してname属性をそろえる
          prevInput.forEach((input) => {
            if (input.hasAttribute("name")) {
              input.name = input.name.replace('[]', '');
            }
          })
          //selectタグのname属性にある[]を削除してname属性をそろえる
          prevSelect.forEach((select) => {
            if (select.hasAttribute("name")) {
              select.name = select.name.replace('[]', '');
            }
          })
          //textareaタグのname属性にある[]を削除してname属性をそろえる
          prevTextArea.forEach((textarea) => {
            if (textarea.hasAttribute("name")) {
              textarea.name = textarea.name.replace('[]', '');
            }
          })
          //複製要素にitem-templateをつけないようにする
          contentArea[0].classList.remove("item-template");
          //複製
          const cloneElement = contentArea[0].cloneNode(true);
          //item-templateを付け直して、複製できるようにする
          contentArea[0].classList.add("item-template");
          // 複製した要素の属性を編集
          cloneElement.removeAttribute("style");
          //複製した要素の子孫要素編集
          const inputElement = cloneElement.querySelectorAll("input");
          const selectElement = cloneElement.querySelectorAll("select");
          const textareaElement = cloneElement.querySelectorAll("textarea");
          CategoryNames.forEach((category, setNumber) => {
            inputElement.forEach((input, form) => {
              input.removeAttribute("disabled");
              //type属性別編集
              if (input.type === "text") {
                if (input.name === category) {
                  input.name = category + "[" + prevTd.length + "]";
                  input.value = Object.values(csvElement)[setNumber];
                }
              } else if (input.type === "radio" || input.type === "checkbox") {
                if (input.value === Object.values(csvElement)[setNumber]) {
                  input.checked = true;
                }
              }
            })
            //selectボックス
            selectElement.forEach((select) => {
              select.removeAttribute("disabled");
              //name属性編集
              if (select.name === category) {
                select.name = category + "[" + prevTd.length + "]";
              }
              //optionタグにselectedをつける編集
              const optionElement = select.querySelectorAll("option");
              optionElement.forEach((option, optiNumber) => {
                if (option.value === Object.values(csvElement)[setNumber]) {
                  option.selected = true;
                }
              })
            })
            //テキストエリア
            textareaElement.forEach((textarea) => {
              textarea.removeAttribute("disabled");
              if (textarea.name === category) {
                textarea.name = category + "[" + prevTd.length + "]";
                textarea.value = Object.values(csvElement)[setNumber]
              }
            })
          })
          contentArea[0].before(cloneElement);
        });
      });
      //指定されたファイルの内容を読み取り、完了後csvDatasプロパティにファイルの内容を文字列として格納
      fileReader.readAsText(e.target.files[0]);
    });
  });
</script>

<h2 class="acms-admin-admin-title2">サンプル</h2>
<table class="js-fieldgroup-sortable adminTable acms-admin-table-admin-edit">
  <thead class="acms-admin-hide-sp">
    <tr>
      <th class="acms-admin-table-left acms-admin-admin-config-table-item-handle"> </th>
      <th class="acms-admin-table-left">都道府県</th>
      <th class="acms-admin-table-left">ランチセット</th>
      <th class="acms-admin-table-left">デザート</th>
      <th class="acms-admin-table-left">ホテル</th>
      <th class="acms-admin-table-left">その他</th>
      <th class="acms-admin-table-left acms-admin-admin-config-table-action">削除</th>
    </tr>
  </thead>
  <tbody>
    <!-- BEGIN sample:loop -->
    <tr class="sortable-item">
      <td class="item-handle acms-admin-table-nowrap">
        <i class="acms-admin-icon-sort"></i>
      </td>
      <td>
        <input type="text" name="prefectures[]" value="{prefectures}" class="acms-admin-form-width-full" />
      </td>
      <td>
        <div class="acms-admin-form-radio">
          <input type="radio" name="lanchSet[]" value="sukiyaki" {lanchSet:checked#sukiyaki}
            id="input-radio-lanchSet-sukiyaki" />
          <label for="input-radio-lanchSet-sukiyaki">
            <i class="acms-admin-ico-radio"></i>すき焼き</label>
        </div>
        <div class="acms-admin-form-radio">
          <input type="radio" name="lanchSet[]" value="shabushabu" {lanchSet:checked#shabushabu}
            id="input-radio-lanchSet-shabushabu" />
          <label for="input-radio-lanchSet-shabushabu">
            <i class="acms-admin-ico-radio"></i>しゃぶしゃぶ</label>
        </div>
        <div class="acms-admin-form-radio">
          <input type="radio" name="lanchSet[]" value="susi" {lanchSet:checked#susi} id="input-radio-lanchSet-susi" />
          <label for="input-radio-lanchSet-susi">
            <i class="acms-admin-ico-radio"></i>お寿司</label>
        </div>
        <div class="acms-admin-form-radio">
          <input type="radio" name="lanchSet[]" value="unagi" {lanchSet:checked#unagi}
            id="input-radio-lanchSet-unagi" />
          <label for="input-radio-lanchSet-unagi">
            <i class="acms-admin-ico-radio"></i>うなぎ丼</label>
        </div>
      </td>
      <td>
        <div class="acms-admin-form-checkbox">
          <input type="checkbox" name="desset[]" value="need" {lanchSet:checked#need} id="input-checkbox-desset-need" />
          <label for="input-checkbox-desset-need">
            <i class="acms-admin-ico-checkbox"></i>デザート</label>
        </div>
      </td>
      <td>
        <select name="hotel[]" class="acms-admin-form-width-full">
          <option value=""></option>
          <option value="kapuseruHotel" {hotel:selected#kapuseruHotel}>カプセルホテル</option>
          <option value="resortHotel" {hotel:selected#resortHotel}>リゾートホテル</option>
          <option value="businessHotel" {hotel:selected#businessHotel}>ビジネスホテル</option>
        </select>
      </td>
      <td>
        <textarea name="option[]" class="acms-admin-form-width-full">{option}</textarea>
      </td>
      <td class="acms-admin-table-nowrap">
        <input type="button" class="item-delete acms-admin-btn-admin acms-admin-btn-admin-danger" value="削除" />
      </td>
    </tr>
    <!-- END sample:loop -->
    <tr class="sortable-item item-template">
      <td class="item-handle acms-admin-table-nowrap">
        <i class="acms-admin-icon-sort"></i>
      </td>
      <td>
        <input type="text" name="prefectures[]" value="" class="acms-admin-form-width-full" />
      </td>
      <td>
        <div class="acms-admin-form-radio">
          <input type="radio" name="lanchSet[]" value="sukiyaki" id="input-radio-lanchSet-sukiyaki" />
          <label for="input-radio-lanchSet-sukiyaki">
            <i class="acms-admin-ico-radio"></i>すき焼き</label>
        </div>
        <div class="acms-admin-form-radio">
          <input type="radio" name="lanchSet[]" value="shabushabu" id="input-radio-lanchSet-shabushabu" />
          <label for="input-radio-lanchSet-shabushabu">
            <i class="acms-admin-ico-radio"></i>しゃぶしゃぶ</label>
        </div>
        <div class="acms-admin-form-radio">
          <input type="radio" name="lanchSet[]" value="susi" id="input-radio-lanchSet-susi" />
          <label for="input-radio-lanchSet-susi">
            <i class="acms-admin-ico-radio"></i>お寿司</label>
        </div>
        <div class="acms-admin-form-radio">
          <input type="radio" name="lanchSet[]" value="unagi" id="input-radio-lanchSet-unagi" />
          <label for="input-radio-lanchSet-unagi">
            <i class="acms-admin-ico-radio"></i>うなぎ丼</label>
        </div>
      </td>
      <td>
        <div class="acms-admin-form-checkbox">
          <input type="checkbox" name="desset[]" id="input-checkbox-desset-need" />
          <label for="input-checkbox-desset-need">
            <i class="acms-admin-ico-checkbox"></i>デザート</label>
        </div>
      </td>
      <td>
        <select name="hotel[]" class="acms-admin-form-width-full">
          <option value=""></option>
          <option value="kapuseruHotel">カプセルホテル</option>
          <option value="resortHotel">リゾートホテル</option>
          <option value="businessHotel">ビジネスホテル</option>
        </select>
      </td>
      <td>
        <textarea name="option[]" class="acms-admin-form-width-full"></textarea>
      </td>
      <td class="acms-admin-table-nowrap">
        <input type="button" class="item-delete acms-admin-btn-admin acms-admin-btn-admin-danger" value="削除" />
      </td>
    </tr>
  </tbody>
  <tfoot>
    <tr>
      <td colSpan="6">
        <input type="button" class="item-insert acms-admin-btn-admin" value="追加" />
      </td>
    </tr>
  </tfoot>
</table>
<input type="hidden" name="@sample[]" value="prefectures" />
<input type="hidden" name="field[]" value="prefectures" />
<input type="hidden" name="@sample[]" value="lanchSet" />
<input type="hidden" name="field[]" value="lanchSet" />
<input type="hidden" name="@sample[]" value="hotel" />
<input type="hidden" name="field[]" value="hotel" />
<input type="hidden" name="@sample[]" value="option" />
<input type="hidden" name="field[]" value="option" />
<input type="hidden" name="@sample[]" value="desset" />
<input type="hidden" name="field[]" value="desset" />
<input type="hidden" name="field[]" value="@sample" />

<input type="file" class="item-insert" id="uploadFile">
